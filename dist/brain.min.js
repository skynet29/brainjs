console.log("jQuery version",$.fn.jquery);var brain={controls:[],registerControl:function(t,n){this.controls[t]=n},createCustomControl:function(t,n,e){return{viewCtrl:new brain.ViewControler(t,n),render:function(){console.log("CustomControl.render"),t.append(e),this.viewCtrl.render()},attr:function(t,n){console.log("CustomControl.attr",t,n),this.viewCtrl.setProp(t,n)}}}};$.Event.prototype.info=function(){return $(this.target).closest(".bn-item").get(0).info},$.fn.bnFilter=function(t){return this.find(t).add(this.filter(t))},$.fn.bnFindAttr=function(t,n){var e="["+t+'="'+n+'"]';return this.bnFilter(e)},$.fn.bnVisible=function(t){return 1==t?this.show():this.hide(),this},$.fn.bnFind=function(t,n,e){e=void 0==e||e,this.bnFilter("["+t+"]").each(function(){var r=$(this),i=r.attr(t);1==e&&r.removeAttr(t),n(r,i)})},$.fn.bnFindEx=function(t,n){this.bnFind(t,function(t,e){e.split(",").forEach(function(e){var r=e.split(":"),i=r[0].trim(),o=r[1].trim();n(t,i,o)})})},$.fn.bnEach=function(t,n){if(!Array.isArray(n))return this;this.empty().append(n.map(function(n,e){t.controler.renderView(t.ref,n);var r=t.template.clone(!0);return r.get(0).info={idx:e,data:n},r}))},$.fn.bnVal=function(t){var n=this.get(0).ctrl;if(void 0!=n)return n.val(t);var e=this.attr("type");if(void 0==t)return"checkbox"==e?this.prop("checked"):this.val();"checkbox"==e?this.prop("checked",t):this.val(t)},$.fn.bnAttr=function(t,n){var e=this.get(0).ctrl;return void 0!=e?e.attr(t,n):void 0==n?this.attr(t):void this.attr(t,n)},brain.ViewControler=function(){function t(t,n){var e=this;"string"==typeof t&&(t=$(t)),this.rendered=!1,this.elt=t,this.data={update:function(t,n){e.update(t,n)},setData:function(t){e.setData(t)}};var r=n.init;"function"==typeof r&&r.call(this.data),this.methods={},this.rules=n.rules||{};for(var i in n.methods)this.methods[i]=n.methods[i].bind(this.data)}return t.prototype.renderControl=function(){this.elt.bnFind("bn-control",function(t,n){console.log("bn-control 2nd",n);var e=t.get(0).ctrl;void 0!=e&&"function"==typeof e.render&&e.render()})},t.prototype.render=function(){console.log("ViewControler.render"),this.ref=this.computeRef(this.elt),this.renderView(this.ref,this.data),this.renderControl(),this.rendered=!0},t.prototype.getValue=function(t,n){if("$item"==n)return t;var e=t[n];if(n.startsWith("@")){var r=n.substr(1),i=this.methods[r];"function"==typeof i&&(e=i(t))}return e},t.prototype.renderView=function(t,n){for(var e in t){var r=this.getValue(n,e),i=t[e];this.updateView(i,r)}},t.prototype.updateView=function(t,n){t.forEach(function(t){var e=$(t.elt),r=$.fn[t.func];void 0!=t.arg?r.call(e,t.arg,n):r.call(e,n)})},t.prototype.updateVariable=function(t,n){var e=this.ref[t];if(void 0!=e){var r=this.getValue(this.data,t);this.updateView(e,r)}for(var i in this.rules)-1!=this.rules[i].indexOf(t)&&this.updateVariable(i)},t.prototype.update=function(t){var n=this;t.split(",").forEach(function(t){n.updateVariable(t.trim())})},t.prototype.setData=function(t){$.extend(this.data,t),this.update(Object.keys(t).toString())},t.prototype.setProp=function(t,n){this.data[t]=n,this.rendered&&this.updateVariable(t)},t.prototype.computeRef=function(t){function n(t,n,r,i){void 0==e[n]&&(e[n]=[]),e[n].push({elt:t.get(0),func:r,arg:i})}var e={},r=this;return t.bnFind("bn-each",function(t,e){var i=t.children().detach();i.addClass("bn-item"),n(t,e,"bnEach",{ref:r.computeRef(i),template:i,controler:r})}),t.bnFind("bn-control",function(t,n){console.log("bn-control",n);var e=brain.controls[n];"function"==typeof e?t.get(0).ctrl=e(t):console.warn("control",n,"is not correctly registered")},!1),t.bnFind("bn-text",function(t,e){n(t,e,"text")}),t.bnFind("bn-model",function(t,e){n(t,e,"bnVal");var i=t.attr("bn-update");void 0!=i&&(t.removeAttr("bn-update"),t.on(i,function(){var n=t.bnVal();"number"==typeof r.data[e]&&(n=parseFloat(n)),r.setProp(e,n)}))}),t.bnFindEx("bn-style",function(t,e,r){n(t,r,"css",e)}),t.bnFindEx("bn-attr",function(t,e,r){n(t,r,"bnAttr",e)}),t.bnFind("bn-visible",function(t,e){n(t,e,"bnVisible")}),t.bnFindEx("bn-event",function(t,n,e){var i=r.methods[e];"function"==typeof i&&t.on(n,i)}),e},t}(),brain.registerControl("checkgroup",function(t){return t.bnFindAttr("type","checkbox").click(function(){t.trigger("checkgroupChange")}),{val:function(n){if(void 0==n){var e=[];return t.bnFilter("input:checked").each(function(){e.push($(this).attr("value"))}),e}n.forEach(function(n){t.bnFindAttr("value",n).prop("checked",!0)})}}}),brain.registerControl("radiogroup",function(t){return t.bnFindAttr("type","radio").click(function(){t.bnFilter("input:checked").prop("checked",!1),$(this).prop("checked",!0),t.trigger("radiogroupChange")}),{val:function(n){if(void 0==n)return t.bnFilter("input:checked").attr("value");t.bnFilter("input:checked").prop("checked",!1),t.bnFindAttr("value",n).prop("checked",!0)}}}),brain.registerControl("menu",function(t){return t.addClass("bn-menu"),t.find("> li").click(function(){t.children("li.selected").removeClass("selected"),$(this).addClass("selected"),t.trigger("menuChange")}),{val:function(n){if(void 0==n)return t.children("li.selected").attr("value");t.children("li.selected").removeClass("selected"),t.children("li").bnFindAttr("value",n).addClass("selected")}}}),brain.registerControl("pager",function(t){return{attr:function(n,e){if("page"==n){if(void 0==e)return t.children(":visible").attr("name");t.children(":visible").hide(),t.bnFindAttr("name",e).show()}}}});